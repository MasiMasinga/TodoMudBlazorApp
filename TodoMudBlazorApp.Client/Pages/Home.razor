@page "/"
@rendermode InteractiveWebAssembly
@inject HttpClient Http
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Todo List</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">My Todo List</MudText>
    <MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">Manage your tasks efficiently</MudText>

    <MudPaper Elevation="2" Class="pa-4">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6">Tasks</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialog">
                Add Todo
            </MudButton>
        </div>

        @if (_isLoading)
        {
            <div class="d-flex justify-center py-8">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" />
            </div>
        }
        else if (!_todos.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                No todos found. Click "Add Todo" to create your first task!
            </MudAlert>
        }
        else
        {
            <MudTable Items="@_todos" Hover="true" Striped="true" Dense="true" Elevation="1">
                <HeaderContent>
                    <MudTh>Status</MudTh>
                    <MudTh>Title</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Status">
                        <MudSwitch T="bool" @bind-Checked="@context.IsCompleted" Color="Color.Success" OnCheckedChanged="@(() => ToggleTodo(context))" />
                    </MudTd>
                    <MudTd DataLabel="Title">
                        <MudText Typo="@(context.IsCompleted ? Typo.body2 : Typo.body1)" 
                                 Style="@(context.IsCompleted ? "text-decoration: line-through; opacity: 0.6;" : "")">
                            @context.Title
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Created">
                        <MudText Typo="Typo.caption">@context.CreatedAt.ToString("MMM dd, yyyy")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Color="Color.Primary" 
                                      Size="Size.Small" 
                                      OnClick="@(() => OpenEditDialog(context))" 
                                      Title="Edit" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      Size="Size.Small" 
                                      OnClick="@(() => DeleteTodo(context))" 
                                      Title="Delete" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<TodoItem> _todos = new();
    private bool _isLoading;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(100);
            await LoadTodos();
        }
    }

    private async Task LoadTodos()
    {
        if (_isLoading)
            return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            var httpResponse = await Http.GetAsync("api/todo", cts.Token);
            httpResponse.EnsureSuccessStatusCode();
            var response = await httpResponse.Content.ReadFromJsonAsync<List<TodoItem>>(cts.Token);
            _todos = response ?? new List<TodoItem>();
        }
        catch (TaskCanceledException)
        {
            Snackbar.Add("Request timed out while loading todos", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading todos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters<TodoDialog>
        {
            { x => x.TodoItem, new TodoItem() },
            { x => x.IsEditMode, false }
        };

        var options = new DialogOptions() 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<TodoDialog>("Add Todo", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadTodos();
            StateHasChanged();
        }
    }

    private async Task OpenEditDialog(TodoItem todo)
    {
        var parameters = new DialogParameters<TodoDialog>
        {
            { x => x.TodoItem, new TodoItem 
            { 
                Id = todo.Id, 
                Title = todo.Title, 
                IsCompleted = todo.IsCompleted,
                CreatedAt = todo.CreatedAt,
                UpdatedAt = todo.UpdatedAt
            }},
            { x => x.IsEditMode, true }
        };

        var options = new DialogOptions() 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<TodoDialog>("Edit Todo", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadTodos();
            StateHasChanged();
        }
    }

    private async Task ToggleTodo(TodoItem todo)
    {
        try
        {
            todo.IsCompleted = !todo.IsCompleted;
            var response = await Http.PutAsJsonAsync($"api/todo/{todo.Id}", todo);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Todo updated successfully", Severity.Success);
                await LoadTodos();
            }
            else
            {
                Snackbar.Add("Failed to update todo", Severity.Error);
                await LoadTodos();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating todo: {ex.Message}", Severity.Error);
            await LoadTodos();
        }
    }

    private async Task DeleteTodo(TodoItem todo)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Todo",
            $"Are you sure you want to delete '{todo.Title}'?",
            yesText: "Delete", 
            cancelText: "Cancel",
            options: new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall });

        if (result == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/todo/{todo.Id}");
                
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Todo deleted successfully", Severity.Success);
                    await LoadTodos();
                }
                else
                {
                    Snackbar.Add("Failed to delete todo", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting todo: {ex.Message}", Severity.Error);
            }
        }
    }
}
